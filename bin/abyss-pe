#!/usr/bin/make -f
# Run the ABySS paired-end assembler.
# Written by Shaun Jackman <sjackman@bcgsc.ca>.

ifndef lib
$(error missing argument lib)
endif
ifndef k
$(error missing argument k)
endif
ifndef l
$(error missing argument l)
endif
ifndef c
$(error missing argument c)
endif
ifndef n
$(error missing argument n)
endif
#v=-v

all: $(lib)-contigs.fa

clean:
	rm -f *.len *.adj *.align *.pair *.frag *.pairs *.hist *.dist *.path

.PHONY: all clean
.DELETE_ON_ERROR:
.SECONDARY:

# Single-end assembly

%-1.fa: %.fa
	ABYSS $v -k$k -l$l -ssnp.fa $^
	mv contigs.fa $@

%.len: %.fa
	awk '/^>/ {getline s; print substr($$1, 2), length(s)}' $< >$@

%.adj: %.fa
	AdjList $k $<
	mv AdjList.txt $@

# Coverage cutoff

%-2.fa: %-1.fa
	awk '/^>/ { getline s; if ($$3/($$2-$k+1)>=$c) \
		{ print $$0 "\n" s } }' $< >$@

%-3.fa: %-2.fa
	ABYSS -k$k -l$l -e0 $^
	mv contigs.fa $@
	
# Estimate distances between contigs

%.align: $(lib).fa %.fa
	KAligner $k $^ >$@

%.pair %.frag: %.align
	ParseAligns $k $<
	mv PairAligns.txt $*.pair
	mv DistanceList.txt $*.frag

%.pairs: %.pair
	sort -nk2,2 $< -o $@

%.hist: %.frag
	awk '{x[$$1]++} END {for (i in x) print i, x[i]}' $< >$@

%.dist: %.pairs %.len %.hist
	DistanceEst $k $^ 100 $n
	mv EstimatedLinks.txt $@

# Find overlaps between contigs

%-overlap.fa: %.fa %.adj %.len %.dist
	Overlap $v $k $^ $@

%-4.fa: %-3.fa %-3-overlap.fa
	ABYSS -k$k -l$l -e0 $^
	mv contigs.fa $@

# Paired-end assembly

%.path: %.adj %.len %.dist
	SimpleGraph $v $k $^ 100000
	mv ResolvedPaths.txt $@

%-contigs.fa: %-4.fa %-4.path
	MergePaths $k $^
	mv final.fa $@
