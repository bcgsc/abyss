jobs:  
- job: mac_latest_gcc
  pool:
    vmImage: macOS-latest
  steps:
  - script: |
      find /usr/local/bin -lname '*/Library/Frameworks/Python.framework/*' -delete  # Trying solution from https://github.com/mesonbuild/meson/blob/master/.github/workflows/macos.yml#L87-L92
      sudo rm -rf /Library/Frameworks/Python.framework/
      brew install --force python3 node@18 && brew unlink python3 node@18 && brew unlink python3 node@18 && brew link --overwrite python3 node@18
      find /usr/local/Cellar/python* -name EXTERNALLY-MANAGED -print0 | xargs -0 rm -vf
      brew update
      brew install automake boost openmpi google-sparsehash make pandoc ghc gcc@14 llvm
    displayName: Install common
  - script: |
      wget https://github.com/bcgsc/btllib/releases/download/v1.5.1/btllib-1.5.1.tar.gz
      export CC=gcc-14
      export CXX=g++-14
      tar xzf btllib-1.5.1.tar.gz
      cd btllib-1.5.1
      ./compile
    displayName: Install btllib
  - script: |
      ./autogen.sh
      export CXXFLAGS="$CXXFLAGS -fuse-ld=lld"
      echo $CXXFLAGS
      export CFLAGS="$CFLAGS -fuse-ld=lld"
      export OBJCFLAGS="$OBJCFLAGS -fuse-ld=lld"
      export OBJCXXFLAGS="$OBJCXXFLAGS -fuse-ld=lld"
      export DISTCHECK_CONFIGURE_FLAGS="CC=gcc-14 CXX=g++-14 --with-boost=/usr/local/opt/boost --with-sparsehash=/usr/local/opt/google-sparsehash --with-mpi=/usr/local/opt/openmpi --with-btllib=/Users/runner/work/1/s/btllib-1.5.1/install"
      ./configure CC=gcc-14 CXX=g++-14 --with-boost=/usr/local/opt/boost --with-sparsehash=/usr/local/opt/google-sparsehash --with-mpi=/usr/local/opt/openmpi --with-btllib=/Users/runner/work/1/s/btllib-1.5.1/install
      make -j12 distcheck AM_CXXFLAGS=-Wno-error=dangling-reference
    displayName: Compiling ABySS with gcc-14

- job:
  displayName: mac_latest-compilers-clang
  pool:
    vmImage: 'macOS-latest'
  steps:
  - script: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
  - script: conda create --yes --quiet --name abyss_CI
    displayName: Create Anaconda environment
  - script: |
      source activate abyss_CI
      conda install --yes -c conda-forge mamba python=3.9
      mamba install --yes -c conda-forge -c bioconda compilers make boost-cpp sparsehash openmpi automake perl pandoc meson ninja
    displayName: Install dependencies
  - script: |
      source activate abyss_CI
      wget https://github.com/bcgsc/btllib/releases/download/v1.7.0/btllib-1.7.0.tar.gz
      tar xzf btllib-1.7.0.tar.gz
      cd btllib-1.7.0
      export CC=clang
      export CXX=clang++
      ./compile
    displayName: Install btllib
  - script: |
      source activate abyss_CI
      export CC=clang
      export CXX=clang++
      export DISTCHECK_CONFIGURE_FLAGS="CC=clang CXX=clang++  --with-btllib=/Users/runner/work/1/s/btllib-1.7.0/install"
      ./autogen.sh
      ./configure  --with-btllib=/Users/runner/work/1/s/btllib-1.7.0/install
      make -j12 distcheck AM_CXXFLAGS=-Wno-error=unused-but-set-variable
    displayName: Compiling ABySS
