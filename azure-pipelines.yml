jobs:
- job: linux_gcc8
  pool:
    vmImage: ubuntu-latest
  steps:
  - script: |
      sudo apt-get update -qq
      sudo apt-get install -qq software-properties-common
      sudo add-apt-repository -y "deb http://us.archive.ubuntu.com/ubuntu bionic main universe security"
      sudo add-apt-repository -y "deb http://us.archive.ubuntu.com/ubuntu bionic-updates main universe restricted"
      sudo apt-get update -qq
      sudo apt-get install -qq autoconf automake gcc g++ libboost-dev libgtest-dev libopenmpi-dev libsparsehash-dev make pandoc
    displayName: Install common
  - script: sudo apt-get install -qq gcc-8 g++-8
    displayName: Install gcc-8
  - script: |
      wget https://github.com/bcgsc/btllib/releases/download/v1.4.9/btllib-1.4.9.tar.gz
      tar xzf btllib-1.4.9.tar.gz
      cd btllib-1.4.9
      ./compile
    displayName: Install btllib
  - script: |
      ./autogen.sh
      export DISTCHECK_CONFIGURE_FLAGS="CC=gcc-8 CXX=g++-8"
      ./configure CC=gcc-8 CXX=g++-8 --with-mpi=/usr/lib/openmpi --with-btllib=btllib-1.4.9/install
      make -j12 distcheck
    displayName: Compiling ABySS with gcc-8
- job:
  displayName: ubuntu-latest
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - script: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
  - script: conda create --yes --quiet --name abyss_CI
    displayName: Create Anaconda environment
  - script: |
      source activate abyss_CI
      conda install --yes -c conda-forge mamba python=3.9
      mamba install --yes -c conda-forge -c bioconda compilers make boost-cpp sparsehash openmpi util-linux perl btllib pandoc
    displayName: Install dependencies
  - script: |
      source activate abyss_CI
      ./autogen.sh
      ./configure
      make -j12 distcheck
    displayName: Compiling ABySS with gcc

- job:
  displayName: mac-latest
  pool:
    vmImage: 'macOS-latest'

  steps:
  - script: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
  - script: conda create --yes --quiet --name abyss_CI
    displayName: Create Anaconda environment
  - script: |
      source activate abyss_CI
      conda install --yes -c conda-forge mamba python=3.9
      mamba install --yes -c conda-forge -c bioconda compilers make boost-cpp sparsehash openmpi automake perl btllib pandoc
    displayName: Install dependencies
  - script: |
      source activate abyss_CI
      ./autogen.sh
      ./configure
      make -j12 distcheck
    displayName: Compiling ABySS with clang

